<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8"/>
        <title>Barcelona Bus Stops</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

        <!-- Leaflet -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

        <!-- PapaParse -->
        <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

        <style>
            body,
            html {
                margin: 0;
                height: 100%;
                font-family: sans-serif;
            }

            #map {
                width: 100%;
                height: 100%;
            }

            #filterUI {
                position: absolute;
                top: 10px;
                left: 50px;
                z-index: 1000;
                background: rgba(255, 255, 255, 0.9);
                padding: 10px;
                border-radius: 8px;
                box-shadow: 0 0 5px rgba(0,0,0,0.3);
            }
        </style>
    </head>
    <body>
        <div id="filterUI">
            <label for="typeSelect">Bus Type:</label>
            <select id="typeSelect">
                <option value="All">All</option>
            </select>
        </div>
        <div id="map"></div>

        <script>
            const map = L
                .map('map')
                .setView([
                    41.3851, 2.1734
                ], 13);

            L
                .tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: 'Â© OpenStreetMap contributors'})
                .addTo(map);

            let busStops = [];
            let markersLayer = L
                .layerGroup()
                .addTo(map);

            function populateFilterOptions(data) {
                const typeSet = new Set();

                data.forEach(stop => {
                    if (stop["Transport"]) {
                        typeSet.add(stop["Transport"].trim());
                    }
                });

                const select = document.getElementById("typeSelect");
                typeSet.forEach(type => {
                    const option = document.createElement("option");
                    option.value = type;
                    option.textContent = type;
                    select.appendChild(option);
                });
            }

            function renderStops(filterType) {
                markersLayer.clearLayers();

                busStops.forEach(stop => {
                    if (!stop.Latitude || !stop.Longitude) 
                        return;
                    
                    // Filter op Transport-type
                    if (filterType !== "All" && stop["Transport"] !== filterType) 
                        return;
                    
                    const lat = parseFloat(stop.Latitude);
                    const lng = parseFloat(stop.Longitude);

                    const marker = L
                        .circleMarker([
                            lat, lng
                        ], {
                            radius: 4,
                            fillColor: "#ff5533",
                            color: "#fff",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        })
                        .bindPopup(`
                    <strong>${stop["Bus.Stop"] || "Onbekende halte"}</strong><br/>
                    Type: ${stop["Transport"] || "?"}<br/>
                    District: ${stop["District.Name"] || "?"}<br/>
                    Neighborhood: ${stop["Neighborhood.Name"] || "?"}
                `);

                    markersLayer.addLayer(marker);
                });
            }

            function loadData() {
                Papa.parse("data/bus_stops.csv", {
                    download: true,
                    header: true,
                    complete: (results) => {
                        busStops = results.data;
                        populateFilterOptions(busStops);
                        renderStops("All");
                    }
                });
            }

            document
                .getElementById("typeSelect")
                .addEventListener("change", (e) => {
                    renderStops(e.target.value);
                });

            loadData();
        </script>
    </body>
</html>